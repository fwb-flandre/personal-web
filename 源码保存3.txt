<template>
  <div class="album">
    <div class="uploadButton">
      <el-button type="primary" @click="dialog1 = true" style="margin-top:50px" v-show="buttonVisible">点击上传图片</el-button>
    </div>
    <el-dialog
      :visible.sync="dialog1"
      width="30%">
      <el-upload
        class="upload"
        ref="upload"
        action="https://jsonplaceholder.typicode.com/posts/"
        :http-request="uploadPhoto"
        :file-list="fileList"
        accept=".jpg,.jpeg,.png"
        list-type="picture">
        <el-button size="small" type="primary">点击上传</el-button>
        <div slot="tip" class="el-upload__tip">只能上传jpg/jpeg/png文件，且不超过1mb</div>
      </el-upload>
    </el-dialog>
    <div class="img">
      <div v-for="(item,index) in photo" :key='item' class="base64img">
        <div class="imgDiv"  :style="imgStyle">
          <!-- 引入 viewer 预览图片 -->
          <viewer>
            <img v-bind:src="photo[index]" :style="imgStyle" class="baseImg" @load="imgLoad(index)">
          </viewer>
          <div class="imgDiscribe">
            <div class="imgName">{{photo_name[index]}}</div>
            <el-button type="text" icon="el-icon-edit" class="imgButton1" @click="edit(index, item)"></el-button>
            <el-button type="text" icon="el-icon-download" class="imgButton2" @click="download(index)"></el-button>
            <el-button type="text" icon="el-icon-delete" class="imgButton3" @click="del(index, item)"></el-button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
// export default 只是为了导出，类似 new Vue()
export default {
  name: 'album',
  data () {
    return {
      browserWidth: '',
      photo: [],
      photo_name: [],
      dialog1: false,
      dialog2: false,
      Img: {
        baseImg: [],
        imgDiv: [],
        deleteImg: [],
        imgName: [],
        imgButtons: {
          imgButton1: [],
          imgButton2: [],
          imgButton3: []
        }
      },
      buttonVisible: false,
      err_code: '',
      correct_code: '',
      files: '',
      fileList: [],
      formInline: {
        img: ''
      },
      imgStyle: {
        width: ''
      },
      tunnels: [100, 100, 100]
    }
  },
  watch: {
    err_code (newName, oldName) {
      switch (this.err_code) {
        case 1:
          this.$message.error('图片已存在')
          this.$refs.upload.clearFiles()
          this.err_code = ''
          break
      }
    },
    correct_code (newName, oldName) {
      switch (this.correct_code) {
        case 1:
          this.$message.success('图片已添加')
          this.$refs.upload.clearFiles()
          this.correct_code = ''
          break
        case 2:
          this.$message.success('删除成功')
          break
        case 3:
          break
        case 4:
          this.$message.success('修改成功')
          break
      }
    },
    // 根据浏览器大小调节图片大小
    browserWidth (newName, oldName) {
      this.tunnels = [100, 100, 100]
      for (var i = 0; i < this.photo.length; i++) {
        this.imgLoad(i)
      }
    }
  },
  methods: {
    // 修改照片名字模块
    edit (index, item) {
      this.$prompt('修改照片名字', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消'
      }).then(({ value }) => {
        this.axios.post('http://127.0.0.1:8080/api/album/update_name', {
          photo: item,
          name: value
        })
          .then(response => {
            this.err_code = response.data.err_code
            this.correct_code = response.data.correct_code
            this.showPhoto()
          })
      }).catch(() => {
        // 取消后进行的操作
      })
    },
    // 下载模块
    download (index) {
      var file = this.base64ToFile(this.photo[index], '')
      var filename = this.photo_name[index]
      const link = document.createElement('a')
      link.href = URL.createObjectURL(file)
      link.download = filename // 这里填保存成的文件名
      link.click()
      URL.revokeObjectURL(link.href)
    },
    base64ToFile (dataurl, filename) {
      var arr = dataurl.split(',')
      var mime = arr[0].match(/:(.*?);/)[1]
      // 用于解码 base64
      var bstr = atob(arr[1])
      var n = bstr.length
      // 将 string 类型转为 utf-16格式
      var u8arr = new Uint8Array(n)
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n)
      }
      return new File([u8arr], filename, { type: mime }) // file 类型
    },
    // 删除模块
    del (index, item) {
      this.$confirm('此操作将永久删除该图片, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        // 将想要删除的元素置为空
        this.Img.baseImg[index].style.width = 0
        this.Img.imgDiv[index].style.width = 0
        this.Img.imgName[index].style.fontSize = 0
        this.Img.imgButtons.imgButton1[index].style.fontSize = 0
        this.Img.imgButtons.imgButton2[index].style.fontSize = 0
        this.Img.imgButtons.imgButton3[index].style.fontSize = 0
        // 记录删除元素索引
        this.Img.deleteImg[index] = index
        this.axios.post('http://127.0.0.1:8080/api/album/delete', {
          photo: item
        })
          .then(response => {
            this.err_code = response.data.err_code
            this.correct_code = response.data.correct_code
            // 重新排列瀑布流
            this.tunnels = [100, 100, 100]
            for (var i = 0; i < this.photo.length; i++) {
              if (this.Img.deleteImg.indexOf(i) < 0) {
                this.imgLoad(i)
              }
            }
            this.showPhoto()
          })
      }).catch(() => {
        // 取消后进行的操作
      })
    },
    // 上传模块
    // http-request 默认回调参数为 param
    uploadPhoto (param) {
      this.$confirm('是否上传此图片', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        var reader = new FileReader()
        // 读取文件并为 result 属性编码 base64
        reader.readAsDataURL(param.file)
        // 限制文件大小
        if (param.file.size > 1024 * 1024) {
          this.$message.error('文件超出大小限制')
          this.$refs.upload.clearFiles()
        } else {
          reader.onload = e => {
            this.formInline.img = e.target.result
            this.axios.post('http://127.0.0.1:8080/api/album', {
              photo: this.formInline.img,
              name: param.file.name
            })
              .then(response => {
                this.err_code = response.data.err_code
                this.correct_code = response.data.correct_code
                this.showPhoto()
                // 重置已被删除的列表
                this.deleteImg = []
              })
          }
        }
      }).catch(() => {
        this.$refs.upload.clearFiles()
      })
    },
    // 更新模块
    showPhoto () {
      this.axios.post('http://127.0.0.1:8080/api/album/update', {
      })
        .then(response => {
          this.err_code = response.data.err_code
          this.correct_code = response.data.correct_code
          this.photo = []
          this.photo_name = []
          for (let key in response.data.result) {
            // 必须要用 push 才能触发 vue 刷新机制
            this.photo.push(response.data.result[key].photo)
            this.photo_name.push(response.data.result[key].name)
          }
        })
    },
    // 验证码模块
    open () {
      this.$prompt('请输入验证码', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消'
      }).then(({ value }) => {
        if (value === '1314') {
          this.buttonVisible = true
          // 需要减去浏览器滚动条的宽度：17 px , window.innerWidth 为浏览器宽度加上滚动条的宽度
          this.browserWidth = window.innerWidth - 17
          this.showPhoto()
          // 检测浏览器大小变化
          window.onresize = () => {
            return (() => {
              this.browserWidth = window.innerWidth - 17
            })()
          }
          this.imgStyle.width = this.browserWidth / 3 - 20 + 'px'
        } else {
          this.$message.error('验证码错误')
          this.open()
        }
      }).catch(() => {
        window.location.href = 'http://localhost:8080/'
      })
    },
    // 瀑布流模块
    imgLoad (index) {
      this.definition()
      let smallIndex = this.indexOfSmallest(this.tunnels)
      // 控制图片间隔
      let photoDistance = 15 - smallIndex * 5
      // 具体实现方法
      this.Img.baseImg[index].style.width = this.browserWidth / 3 - 20 + 'px'
      this.Img.imgDiv[index].style.width = this.Img.baseImg[index].style.width
      let imgHeight = this.Img.baseImg[index].offsetHeight
      this.Img.imgDiv[index].style.left = this.browserWidth / 3 * smallIndex + photoDistance + 'px'
      this.Img.imgDiv[index].style.top = this.tunnels[smallIndex] + 'px'
      this.tunnels[smallIndex] += 130 + imgHeight
      this.selfAdaption(index)
      // 循环到最后一场
      if (index + 1 === this.photo.length) {
        // 检测滚动条
        if (this.detectScrollbar() === true) {
          this.browserWidth = window.innerWidth - 17
        }
      }
    },
    indexOfSmallest (a) {
      var lowest = 0
      for (let i = 1; i < a.length; i++) {
        if (a[i] < a[lowest]) lowest = i
      }
      return lowest
    },
    // 元素定义
    definition () {
      this.Img.baseImg = document.getElementsByClassName('baseImg')
      this.Img.imgDiv = document.getElementsByClassName('imgDiv')
      this.Img.imgName = document.getElementsByClassName('imgName')
      this.Img.imgButtons.imgButton1 = document.getElementsByClassName('imgButton1')
      this.Img.imgButtons.imgButton2 = document.getElementsByClassName('imgButton2')
      this.Img.imgButtons.imgButton3 = document.getElementsByClassName('imgButton3')
    },
    selfAdaption (index) {
      // 实现字体自适应
      this.Img.imgName[index].style.fontSize = window.innerWidth / 60 + 'px'
      // 实现按钮大小自适应
      this.Img.imgButtons.imgButton1[index].style.marginTop = 15 - window.innerWidth / 120 + 'px'
      this.Img.imgButtons.imgButton2[index].style.marginTop = 15 - window.innerWidth / 120 + 'px'
      this.Img.imgButtons.imgButton3[index].style.marginTop = 15 - window.innerWidth / 120 + 'px'
      this.Img.imgButtons.imgButton1[index].style.marginLeft = window.innerWidth / 17 + 'px'
      this.Img.imgButtons.imgButton2[index].style.marginLeft = window.innerWidth / 15 + 'px'
      this.Img.imgButtons.imgButton3[index].style.marginLeft = window.innerWidth / 15 + 'px'
      this.Img.imgButtons.imgButton1[index].style.fontSize = window.innerWidth / 60 + 'px'
      this.Img.imgButtons.imgButton2[index].style.fontSize = window.innerWidth / 60 + 'px'
      this.Img.imgButtons.imgButton3[index].style.fontSize = window.innerWidth / 60 + 'px'
    },
    // 检测滚动条是否存在
    detectScrollbar () {
      let biggest = this.indexOfBiggest(this.tunnels)
      if (this.tunnels[biggest] > document.body.clientHeight) return true
      return false
    },
    indexOfBiggest (a) {
      let biggest = 0
      for (let i = 1; i < a.length; i++) {
        if (a[i] > a[biggest]) biggest = i
      }
      return biggest
    }
  },
  // 页面完全渲染后执行该生命周期函数
  mounted () {
    this.open()
    // 重新显示滚动条
    document.body.parentNode.style.overflowY = 'auto'
    // 隐藏 X 轴滚动条
    document.body.parentNode.style.overflowX = 'hidden'
    // 背景置为浅灰色
    document.body.parentNode.style.background = '#A8A8A8'
  }
}
</script>

<style scoped>
.album {
  height: 100%;
  width: 100%;
}
.imgDiv {
  position: absolute;
  /* 取消元素间间隔 */
  font-size: 0px;
}
.imgName {
  padding-top: 10px;
  display: flex;
  justify-content: center;
}
.baseImg {
  /* 鼠标变手型 */
  cursor: pointer;
}
.uploadButton {
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.imgDiscribe {
  height: 100px;
  font-size: 12px;
  background-color: white;
}
</style>
